{
  "ruleChain": {
    "name": "Root Rule Chain",
    "type": "CORE",
    "firstRuleNodeId": null,
    "root": false,
    "debugMode": false,
    "configuration": null,
    "additionalInfo": null
  },
  "metadata": {
    "version": 48,
    "firstNodeIndex": 6,
    "nodes": [
      {
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode",
        "name": "Save Timeseries",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 0
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "defaultTTL": 0,
          "useServerTs": false,
          "processingSettings": {
            "type": "ON_EVERY_MESSAGE"
          }
        },
        "additionalInfo": {
          "description": null,
          "layoutX": 820,
          "layoutY": 374
        }
      },
      {
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "Save Client Attributes",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 3,
        "configuration": {
          "processingSettings": {
            "type": "ON_EVERY_MESSAGE"
          },
          "scope": "CLIENT_SCOPE",
          "notifyDevice": false,
          "sendAttributesUpdatedNotification": false,
          "updateAttributesOnlyOnValueChange": true
        },
        "additionalInfo": {
          "layoutX": 444,
          "layoutY": 188
        }
      },
      {
        "type": "org.thingsboard.rule.engine.filter.TbMsgTypeSwitchNode",
        "name": "Message Type Switch",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "version": 0
        },
        "additionalInfo": {
          "layoutX": 212,
          "layoutY": 297
        }
      },
      {
        "type": "org.thingsboard.rule.engine.action.TbLogNode",
        "name": "Log RPC from Device",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);",
          "tbelScript": "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);"
        },
        "additionalInfo": {
          "layoutX": 454,
          "layoutY": 90
        }
      },
      {
        "type": "org.thingsboard.rule.engine.action.TbLogNode",
        "name": "Log Other",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);",
          "tbelScript": "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);"
        },
        "additionalInfo": {
          "layoutX": 691,
          "layoutY": 177
        }
      },
      {
        "type": "org.thingsboard.rule.engine.rpc.TbSendRPCRequestNode",
        "name": "RPC Call Request",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "timeoutInSeconds": 60
        },
        "additionalInfo": {
          "layoutX": 698,
          "layoutY": 263
        }
      },
      {
        "type": "org.thingsboard.rule.engine.profile.TbDeviceProfileNode",
        "name": "Device Profile Node",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "persistAlarmRulesState": false,
          "fetchAlarmRulesStateOnStart": false
        },
        "additionalInfo": {
          "description": "Process incoming messages from devices with the alarm rules defined in the device profile. Dispatch all incoming messages with \"Success\" relation type.",
          "layoutX": 232,
          "layoutY": 90
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Calculador de Balance Energético",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "return {msg: msg, metadata: metadata, msgType: msgType};",
          "tbelScript": "return {\r\n    msg: {\r\n        trigger: true\r\n    },\r\n    metadata: {\r\n        deviceName: \"Simulador-Principal\"\r\n    },\r\n    msgType: \"POST_TELEMETRY_REQUEST\"\r\n};"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 0,
          "layoutY": 210
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Solar",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "originatorSource": "ENTITY",
          "entityType": "DEVICE",
          "entityNamePattern": "FV-01",
          "relationsQuery": {
            "fetchLastLevelOnly": false,
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "DEVICE"
                ]
              }
            ]
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 539,
          "layoutY": 764
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Eolica",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "originatorSource": "ENTITY",
          "entityType": "DEVICE",
          "entityNamePattern": "WIND-01",
          "relationsQuery": {
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [],
                "negate": false
              }
            ],
            "fetchLastLevelOnly": false
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 534,
          "layoutY": 703
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Casa",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "originatorSource": "ENTITY",
          "entityType": "DEVICE",
          "entityNamePattern": "HOUSE-01",
          "relationsQuery": {
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [],
                "negate": false
              }
            ],
            "fetchLastLevelOnly": false
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 519,
          "layoutY": 478
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Inversor",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "originatorSource": "ENTITY",
          "entityType": "DEVICE",
          "entityNamePattern": "INV-01",
          "relationsQuery": {
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [],
                "negate": false
              }
            ],
            "fetchLastLevelOnly": false
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 529,
          "layoutY": 587
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Bateria",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "originatorSource": "ENTITY",
          "entityType": "DEVICE",
          "entityNamePattern": "BATT-01",
          "relationsQuery": {
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [],
                "negate": false
              }
            ],
            "fetchLastLevelOnly": false
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 528,
          "layoutY": 535
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Red",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "originatorSource": "ENTITY",
          "entityType": "DEVICE",
          "entityNamePattern": "GRID-01",
          "relationsQuery": {
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [],
                "negate": false
              }
            ],
            "fetchLastLevelOnly": false
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 531,
          "layoutY": 643
        }
      },
      {
        "type": "org.thingsboard.rule.engine.debug.TbMsgGeneratorNode",
        "name": "Generador de enrgia",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 2,
        "configuration": {
          "msgCount": 0,
          "periodInSeconds": 5,
          "scriptLang": "TBEL",
          "jsScript": "var fv_p_in       = +(Math.random() * 3).toFixed(2);\r\n    var wind_p_dc     = +(Math.random() * 3).toFixed(2);\r\n    var grid_p_import = +(Math.random() * 3).toFixed(2);\r\n    \r\n    var p_auto = +(-Math.random() * 3).toFixed(2);\r\n\r\n    var batt_p = +((Math.random() * 6) - 3).toFixed(2);\r\n    var batt_soc = +(((batt_p + 3) / 6) * 100).toFixed(0);\r\n\r\n    var house_p_load = fv_p_in + wind_p_dc + grid_p_import + p_auto + batt_p;\r\n\r\n    return {\r\n        msg: {\r\n            fv_p_in: fv_p_in,\r\n            wind_p_dc: wind_p_dc,\r\n            grid_p_import: grid_p_import,\r\n            p_auto: p_auto,\r\n            batt_p: batt_p,\r\n            batt_soc: batt_soc,\r\n            house_p_load: +house_p_load.toFixed(2)\r\n        },\r\n        metadata: prevMetadata, \r\n        msgType: prevMsgType\r\n        \r\n    };",
          "tbelScript": "return {\r\n    msg: {\r\n        trigger: true\r\n    },\r\n    metadata: {\r\n        deviceName: \"Simulador-Principal\"\r\n    },\r\n    msgType: \"POST_TELEMETRY_REQUEST\"\r\n};",
          "originatorId": "13814000-1dd2-11b2-8080-808080808080",
          "originatorType": "RULE_NODE"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 34,
          "layoutY": 377
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Auto",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "originatorSource": "ENTITY",
          "entityType": "DEVICE",
          "entityNamePattern": "CAR-01",
          "relationsQuery": {
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [],
                "negate": false
              }
            ],
            "fetchLastLevelOnly": false
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 521,
          "layoutY": 422
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "calculos",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "// La lógica de generación se queda dentro de la función\r\nvar fv_p_in       = +(Math.random() * 3).toFixed(2);\r\nvar wind_p_dc     = +(Math.random() * 3).toFixed(2);\r\nvar grid_p_import = +(Math.random() * 3).toFixed(2);\r\nvar p_auto        = +(-Math.random() * 3).toFixed(2);\r\n\r\nvar batt_p        = +((Math.random() * 6) - 3).toFixed(2);\r\nvar batt_soc      = +(((batt_p + 3) / 6) * 100).toFixed(0);\r\n\r\nvar house_p_load  = fv_p_in + wind_p_dc + grid_p_import + p_auto + batt_p;\r\n\r\n// IMPORTANTE: Este es el formato que ThingsBoard necesita para que el flujo siga\r\nreturn {\r\n    msg: {\r\n        fv_p_in: fv_p_in,\r\n        wind_p_dc: wind_p_dc,\r\n        grid_p_import: grid_p_import,\r\n        p_auto: p_auto,\r\n        batt_p: batt_p,\r\n        batt_soc: batt_soc,\r\n        house_p_load: +house_p_load.toFixed(2)\r\n    },\r\n    msgType: \"POST_TELEMETRY_REQUEST\"\r\n \r\n};",
          "tbelScript": "return {msg: msg, metadata: metadata, msgType: msgType};"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 221,
          "layoutY": 472
        }
      }
    ],
    "connections": [
      {
        "fromIndex": 2,
        "toIndex": 0,
        "type": "Post telemetry"
      },
      {
        "fromIndex": 2,
        "toIndex": 1,
        "type": "Post attributes"
      },
      {
        "fromIndex": 2,
        "toIndex": 3,
        "type": "RPC Request from Device"
      },
      {
        "fromIndex": 2,
        "toIndex": 4,
        "type": "Other"
      },
      {
        "fromIndex": 2,
        "toIndex": 5,
        "type": "RPC Request to Device"
      },
      {
        "fromIndex": 6,
        "toIndex": 2,
        "type": "Success"
      },
      {
        "fromIndex": 7,
        "toIndex": 2,
        "type": "Success"
      },
      {
        "fromIndex": 8,
        "toIndex": 0,
        "type": "Success"
      },
      {
        "fromIndex": 9,
        "toIndex": 0,
        "type": "Success"
      },
      {
        "fromIndex": 10,
        "toIndex": 0,
        "type": "Success"
      },
      {
        "fromIndex": 11,
        "toIndex": 0,
        "type": "Success"
      },
      {
        "fromIndex": 12,
        "toIndex": 0,
        "type": "Success"
      },
      {
        "fromIndex": 13,
        "toIndex": 0,
        "type": "Success"
      },
      {
        "fromIndex": 14,
        "toIndex": 16,
        "type": "Success"
      },
      {
        "fromIndex": 15,
        "toIndex": 0,
        "type": "Success"
      },
      {
        "fromIndex": 16,
        "toIndex": 8,
        "type": "Success"
      },
      {
        "fromIndex": 16,
        "toIndex": 9,
        "type": "Success"
      },
      {
        "fromIndex": 16,
        "toIndex": 10,
        "type": "Success"
      },
      {
        "fromIndex": 16,
        "toIndex": 11,
        "type": "Success"
      },
      {
        "fromIndex": 16,
        "toIndex": 12,
        "type": "Success"
      },
      {
        "fromIndex": 16,
        "toIndex": 13,
        "type": "Success"
      },
      {
        "fromIndex": 16,
        "toIndex": 15,
        "type": "Success"
      }
    ],
    "ruleChainConnections": null
  }
}